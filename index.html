<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <title>Prueba de Diagnóstico</title>
        
        <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

        <style>
            body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
            #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
            #start-button { padding: 15px 40px; background: #d90429; color: #fff; border: none; border-radius: 30px; font-weight: bold; font-size: 18px; }
            .hidden { display: none; }
        </style>

        <script>
            AFRAME.registerComponent('master-controller', {
                init: function () {
                    const btn = document.querySelector("#start-button");
                    const splash = document.querySelector("#splash-screen");
                    const hud = document.querySelector("#hud-container");
                    const vid = document.querySelector("#vid");

                    btn.addEventListener('click', () => {
                        splash.classList.add('hidden');
                        hud.setAttribute('visible', 'true');
                        vid.muted = true; // Obligatorio para evitar pantalla negra en inicio
                        vid.play();
                    });
                }
            });
            
            AFRAME.registerComponent('fix-video-size', {
                init: function () {
                    var videoEl = document.querySelector("#vid");
                    var planeEl = this.el; 
                    var applySize = function() {
                        if (videoEl.videoWidth > 0 && videoEl.videoHeight > 0) {
                            var aspectRatio = videoEl.videoHeight / videoEl.videoWidth;
                            var isPortrait = window.innerHeight > window.innerWidth;
                            var scaleFactor = isPortrait ? 3.5 : 5;
                            planeEl.setAttribute('width', scaleFactor); 
                            planeEl.setAttribute('height', aspectRatio * scaleFactor);
                        }
                    };
                    videoEl.addEventListener('loadedmetadata', applySize);
                    window.addEventListener('resize', applySize);
                }
            });
        </script>
    </head>

    <body>
        <div id="splash-screen">
            <h2 style="color:#333; margin-bottom: 20px;">PRUEBA DE DIAGNÓSTICO</h2>
            <button id="start-button">INICIAR</button>
        </div>

        <a-scene
            master-controller
            vr-mode-ui="enabled: false"
            renderer="logarithmicDepthBuffer: true; colorManagement: true; sortObjects: true;"
            arjs='sourceType: webcam; debugUIEnabled: false;'
            embedded
        >
            <a-assets>
                <video id="vid" src="senna.mp4" preload="auto" loop crossorigin webkit-playsinline autoplay playsinline></video>
                <a-asset-item id="miModelo" src="IMOLAF-v1.glb"></a-asset-item>
            </a-assets>

            <a-entity light="type: ambient; intensity: 1.5; color: #ffffff"></a-entity>
            <a-entity light="type: directional; intensity: 1; position: 2 4 4"></a-entity>

            <a-entity camera>
                <a-entity id="hud-container" visible="false" position="0 0 -6">
                    
                    <a-video
                        src="#vid"
                        fix-video-size
                        position="0 1.5 -3" 
                        material="shader: flat; src: #vid; side: double;"
                    ></a-video>
                    
                    <a-box color="red" position="-1.5 -1 0" scale="1 1 1"></a-box>

                    <a-entity
                        id="animatedModel"
                        gltf-model="#miModelo"
                        scale="0.15 0.15 0.15"
                        position="1.5 -1 0" 
                        rotation="0 -30 0" 
                    ></a-entity>

                </a-entity>
            </a-entity>
        </a-scene>
    </body>
</html>
