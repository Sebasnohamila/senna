<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <title>Experiencia AR F1</title>
        
        <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

        <style>
            body { margin: 0; overflow: hidden; touch-action: none; background-color: #000; font-family: sans-serif; }
            
            /* Pantalla de carga */
            #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #fff; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
            #splash-screen img { width: 100px; margin-bottom: 20px; }
            .hidden { opacity: 0; pointer-events: none; }
            
            #start-button { padding: 15px 30px; background: #000; color: #fff; border: none; border-radius: 30px; font-size: 16px; font-weight: bold; cursor: pointer; }
        </style>

        <script>
            AFRAME.registerComponent('master-controller', {
                init: function () {
                    const btn = document.querySelector("#start-button");
                    const splash = document.querySelector("#splash-screen");
                    const hud = document.querySelector("#hud-container");
                    const vid = document.querySelector("#vid");
                    const model = document.querySelector("#animatedModel");

                    this.isUnlocked = false;
                    this.startX = 0; this.startY = 0;
                    this.initialDistance = 0; this.initialScaleVector = new THREE.Vector3();

                    btn.addEventListener('click', () => {
                        this.isUnlocked = true;
                        splash.classList.add('hidden');
                        hud.setAttribute('visible', 'true');
                        
                        // Intentar reproducir video
                        vid.play().then(() => {
                            console.log("Video playing");
                        }).catch(e => {
                            // Si falla, intentamos mutearlo (fallback)
                            console.log("Autoplay blocked, trying muted");
                            vid.muted = true;
                            vid.play();
                        });

                        if (model) model.setAttribute('animation-mixer', 'timeScale: 1');
                    });

                    // Gestos (Rotar/Escalar)
                    window.addEventListener('touchstart', (e) => {
                        if (!this.isUnlocked) return;
                        if(e.touches.length === 1) {
                            this.startX = e.touches[0].clientX;
                            this.startY = e.touches[0].clientY;
                        } else if (e.touches.length === 2) {
                            var dx = e.touches[0].clientX - e.touches[1].clientX;
                            var dy = e.touches[0].clientY - e.touches[1].clientY;
                            this.initialDistance = Math.sqrt(dx * dx + dy * dy);
                            if (model) this.initialScaleVector.copy(model.object3D.scale);
                        }
                    });

                    window.addEventListener('touchmove', (e) => {
                        if (!this.isUnlocked || !model) return;
                        if(e.touches.length === 1) {
                            var deltaX = e.touches[0].clientX - this.startX;
                            var deltaY = e.touches[0].clientY - this.startY;
                            this.startX = e.touches[0].clientX;
                            this.startY = e.touches[0].clientY;
                            model.object3D.rotation.y += deltaX * 0.01;
                            model.object3D.rotation.x += deltaY * 0.01;
                        } else if (e.touches.length === 2 && this.initialDistance > 0) {
                             var dx = e.touches[0].clientX - e.touches[1].clientX;
                             var dy = e.touches[0].clientY - e.touches[1].clientY;
                             var scaleFactor = Math.sqrt(dx*dx + dy*dy) / this.initialDistance;
                             var newS = this.initialScaleVector.x * scaleFactor;
                             newS = Math.min(Math.max(newS, 0.05), 2.0);
                             model.object3D.scale.set(newS, newS, newS);
                        }
                    });
                }
            });

            AFRAME.registerComponent('fix-video-size', {
                init: function () {
                    var videoEl = document.querySelector("#vid");
                    var planeEl = this.el; 
                    var applySize = function() {
                        if (videoEl.videoWidth > 0 && videoEl.videoHeight > 0) {
                            var aspectRatio = videoEl.videoHeight / videoEl.videoWidth;
                            var isPortrait = window.innerHeight > window.innerWidth;
                            var scaleFactor = isPortrait ? 3.5 : 5;
                            planeEl.setAttribute('width', scaleFactor); 
                            planeEl.setAttribute('height', aspectRatio * scaleFactor);
                        }
                    };
                    videoEl.addEventListener('loadedmetadata', applySize);
                    window.addEventListener('resize', applySize);
                }
            });
        </script>
    </head>

    <body>
        <div id="splash-screen">
            <img src="logo.png" alt="Logo">
            <button id="start-button">VER EXPERIENCIA</button>
        </div>

        <a-scene
            master-controller
            vr-mode-ui="enabled: false"
            renderer="logarithmicDepthBuffer: true; colorManagement: false; precision: medium;"
            arjs='sourceType: webcam; debugUIEnabled: false;'
            embedded
        >
            <a-assets>
                <video id="vid" src="senna.mp4" preload="auto" loop crossorigin webkit-playsinline autoplay playsinline></video>
                <a-asset-item id="miModelo" src="IMOLAF-v1.glb"></a-asset-item>
            </a-assets>

            <a-entity light="type: ambient; intensity: 3; color: #ffffff"></a-entity>
            <a-entity light="type: directional; intensity: 0.5" position="1 1 1"></a-entity>

            <a-entity camera>
                <a-entity id="hud-container" visible="false" position="0 0 -6">
                    
                    <a-video
                        src="#vid"
                        fix-video-size
                        position="0 1.5 -1.5" 
                        material="shader: flat; src: #vid; side: double;"
                    ></a-video>
                    
                    <a-entity
                        id="animatedModel"
                        gltf-model="#miModelo"
                        scale="0.15 0.15 0.15"
                        position="0 -1 0" 
                        rotation="0 0 0" 
                        animation-mixer="loop: repeat"
                    ></a-entity>

                </a-entity>
            </a-entity>
        </a-scene>
    </body>
</html>
